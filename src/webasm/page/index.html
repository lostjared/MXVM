<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MXVM Debug Compiler</title>
  <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #000;
            color: #e0e0e0;
            line-height: 1.6;
            min-height: 100vh;
        }
        
        .container {
            max-width: 100vw;
            width: 100%;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: #222;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(183, 28, 28, 0.2);
            border: 1px solid #b71c1c;
            text-align: center;
        }
        
        .header h1 {
            color: #ff5252;
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
            text-shadow: 1px 1px 2px #000;
        }
        
        .header p {
            color: #e57373;
            font-size: 1.2rem;
        }
        
        .input-section {
            background: #181818;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(183, 28, 28, 0.1);
            border: 1px solid #b71c1c;
            overflow: hidden;
        }
        
        .input-header {
            background: #b71c1c;
            color: #fff;
            padding: 20px 30px;
            font-size: 1.4rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .input-content {
            padding: 30px;
        }
        
        #codeInput {
            width: 100%;
            height: 300px;
            background: #222;
            border: 1px solid #b71c1c;
            border-radius: 10px;
            padding: 15px;
            color: #e0e0e0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            resize: vertical;
            outline: none;
        }
        
        #codeInput:focus {
            border-color: #ff5252;
            box-shadow: 0 0 10px rgba(255, 82, 82, 0.3);
        }
        
        .button-group {
            margin-top: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .btn {
            background: #b71c1c;
            color: #fff;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(183, 28, 28, 0.3);
        }
        
        .btn:hover {
            background: #d32f2f;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(183, 28, 28, 0.4);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn:disabled {
            background: #444;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .output-section {
            background: #181818;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(183, 28, 28, 0.1);
            border: 1px solid #b71c1c;
            overflow: hidden;
        }
        
        .output-header {
            background: #b71c1c;
            color: #fff;
            padding: 20px 30px;
            font-size: 1.4rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        #output {
            width: 100%;
            box-sizing: border-box;
            padding: 0;
            background: #000;
            color: #e0e0e0;
            min-height: 200px;
            overflow: auto;
        }
        
        #output pre,
        #output code,
        #output textarea {
            width: 100%;
            box-sizing: border-box;
            overflow-x: auto;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            color: #e57373;
            font-style: italic;
        }
        
        .error {
            background: #2c1810;
            border: 1px solid #d32f2f;
            color: #ff8a80;
            padding: 20px;
            margin: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
        }
        
        .example-link {
            color: #ff5252;
            text-decoration: none;
            font-weight: 600;
        }
        
        .example-link:hover {
            color: #ff8a80;
            text-decoration: underline;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .button-group {
                justify-content: center;
            }
            
            #codeInput {
                height: 250px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üîß MXVM Debug Compiler</h1>
      <p>Paste your MXVM source code below to generate debug HTML & assembly</p>
    </div>
    <div class="input-section">
      <div class="input-header">
        <span>üìù MXVM Source Code</span>
        <a href="#" class="example-link" onclick="loadExample()">Load Example</a>
      </div>
      <div class="input-content">
        <textarea id="codeInput" placeholder="Enter your MXVM source code‚Ä¶"></textarea>
        <div class="button-group">
          <button class="btn" id="parseBtn" onclick="parseCode()" disabled>
            üöÄ Parse & Generate Debug HTML
          </button>
          <button class="btn" onclick="clearAll()">
            üóëÔ∏è Clear All
          </button>
          <button class="btn" onclick="copyOutput()">
            üìã Copy Output
          </button>
          <button class="btn" id="downloadZipBtn" disabled>
            üíæ Download Assembly ZIP
          </button>
        </div>
      </div>
    </div>

    <div class="output-section">
      <div class="output-header">
        <span>üìä</span> Debug HTML Output
      </div>
      <div id="output">
        <div class="loading">
          Enter MXVM code above and click ‚ÄúParse & Generate Debug HTML‚Äù to see the output here.
        </div>
      </div>
    </div>
  </div>

  <!-- JSZip for ZIP functionality -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
  <!-- Your Emscripten MXVM module -->
  <script src="mxvm.js?v=1.12"></script>
  <script>
    let mxvmModule       = null;
    let debuggerInstance = null;

    Module.onRuntimeInitialized = () => {
      mxvmModule       = Module;
      debuggerInstance = new mxvmModule.MXVM_Debug();

      document.getElementById('parseBtn').disabled       = false;
      document.getElementById('downloadZipBtn').disabled = true;
      document.getElementById('parseBtn').textContent    = "üöÄ Parse & Generate Debug HTML";
    };

    function parseCode() {
      const code    = document.getElementById('codeInput').value.trim();
      const output  = document.getElementById('output');
      const parseBtn = document.getElementById('parseBtn');
      const zipBtn   = document.getElementById('downloadZipBtn');

      if (!debuggerInstance) {
        return showError("WebAssembly module not loaded yet. Please wait...");
      }
      if (!code) {
        return showError("Please enter some MXVM code to parse.");
      }

      parseBtn.disabled    = true;
      zipBtn.disabled      = true;
      parseBtn.textContent = "üîÑ Parsing...";
      output.innerHTML     = '<div class="loading">Parsing MXVM code‚Ä¶</div>';

      try {
        const html = debuggerInstance.parseToHTML(code);
        output.innerHTML = html;
        zipBtn.disabled = false;
      } catch (err) {
        showError("Parsing failed: " + err.message);
      } finally {
        parseBtn.disabled    = false;
        parseBtn.textContent = "üöÄ Parse & Generate Debug HTML";
      }
    }

    function showError(msg) {
      document.getElementById('output').innerHTML =
        `<div class="error">‚ùå ${msg}</div>`;
    }

    function clearAll() {
      document.getElementById('codeInput').value = '';
      document.getElementById('output').innerHTML =
        '<div class="loading">Enter MXVM code above and click ‚ÄúParse & Generate Debug HTML‚Äù to see the output here.</div>';
      document.getElementById('downloadZipBtn').disabled = true;
    }

    function copyOutput() {
      const out = document.getElementById('output');
      const range = document.createRange();
      range.selectNode(out);
      const sel = window.getSelection();
      sel.removeAllRanges();
      sel.addRange(range);
      try {
        document.execCommand('copy');
        sel.removeAllRanges();
      } catch {
        showError("Failed to copy to clipboard");
      }
    }

    function loadExample() {
   const exampleCode = `program TicTacToe {
  section module { io }
  section object { State, Board, Printer, Rules, Human, AI }

  section data {
    string welcome      = "--- MXVM Tic-Tac-Toe ---\\n"
    string win_msg      = "Player %c wins!\\n"
    string draw_msg     = "It's a draw!\\n"
  }

  section code {
  start:
    alloc Board.board, 8, 9
    print welcome
    call Board.init
    jmp game_loop

  game_loop:
    call Printer.print_board
    mov State.winner, 0
    call Rules.check_win
    cmp State.winner, 0
    jne game_over
    cmp State.turn, 9
    je draw

    mod State.temp, State.turn, 2
    cmp State.temp, 0
    je set_X
    mov State.current_player, State.P_O
    jmp player_turn

  set_X:
    mov State.current_player, State.P_X

  player_turn:
    cmp State.current_player, State.P_O
    je ai_turn
    call Human.turn
    jmp game_loop

  ai_turn:
    call AI.turn
    jmp game_loop

  game_over:
    call Printer.print_board
    cmp State.winner, 1
    je x_wins
    print win_msg, State.P_O
    call Board.release
    done

  x_wins:
    print win_msg, State.P_X
    call Board.release
    done

  draw:
    call Printer.print_board
    print draw_msg
    call Board.release
    done
  }
}

object State {
  section data {
    export int P_X            = 88
    export int P_O            = 79
    export int P_EMPTY        = 46
    export int turn           = 0
    export int current_player = 0
    export int move           = 0
    export int winner         = 0
    export int temp           = 0
  }
}

object Board {
  section data {
    export ptr board = null
    int i = 0
  }

  section code {
  function init:
    mov i, 0
  init_loop:
    cmp i, 9
    jge init_done
    store State.P_EMPTY, board, i, 8
    add i, i, 1
    jmp init_loop
  init_done:
    ret

  function release:
    free board
    ret
  }
}

object Printer {
  section data {
    string row_fmt  = "%c | %c | %c\\n"
    string sep_line = "- + - + - \\n"
    int v1 = 0
    int v2 = 0
    int v3 = 0
  }

  section code {
  function print_board:
    load v1, Board.board, 0, 8
    load v2, Board.board, 1, 8
    load v3, Board.board, 2, 8
    print row_fmt, v1, v2, v3
    print sep_line

    load v1, Board.board, 3, 8
    load v2, Board.board, 4, 8
    load v3, Board.board, 5, 8
    print row_fmt, v1, v2, v3
    print sep_line

    load v1, Board.board, 6, 8
    load v2, Board.board, 7, 8
    load v3, Board.board, 8, 8
    print row_fmt, v1, v2, v3
    ret
  }
}

object Rules {
  section data {
    int a = 0
    int b = 0
    int c = 0
    int v1 = 0
    int v2 = 0
    int v3 = 0
  }

  section code {
  function check_win:
    mov a, 0
    mov b, 1
    mov c, 2
    call check_line
    cmp State.winner, 0
    jne done

    mov a, 3
    mov b, 4
    mov c, 5
    call check_line
    cmp State.winner, 0
    jne done

    mov a, 6
    mov b, 7
    mov c, 8
    call check_line
    cmp State.winner, 0
    jne done

    mov a, 0
    mov b, 3
    mov c, 6
    call check_line
    cmp State.winner, 0
    jne done

    mov a, 1
    mov b, 4
    mov c, 7
    call check_line
    cmp State.winner, 0
    jne done

    mov a, 2
    mov b, 5
    mov c, 8
    call check_line
    cmp State.winner, 0
    jne done

    mov a, 0
    mov b, 4
    mov c, 8
    call check_line
    cmp State.winner, 0
    jne done

    mov a, 2
    mov b, 4
    mov c, 6
    call check_line
  done:
    ret

  function check_line:
    load v1, Board.board, a, 8
    load v2, Board.board, b, 8
    load v3, Board.board, c, 8
    cmp v1, State.P_EMPTY
    je end_line
    cmp v1, v2
    jne end_line
    cmp v1, v3
    jne end_line
    cmp v1, State.P_X
    je set_x
    cmp v1, State.P_O
    je set_o
  end_line:
    ret
  set_x:
    mov State.winner, 1
    ret
  set_o:
    mov State.winner, 2
    ret
  }
}

object Human {
  section data {
    string prompt       = "Player %c, enter position (0-8): "
    string invalid_move = "Invalid move. That spot is taken or out of bounds.\\n"
    string input_buffer, 8
    int    tmp = 0
  }

  section code {
  function turn:
    print prompt, State.current_player
  read_again:
    getline input_buffer
    to_int State.move, input_buffer
    cmp State.move, 0
    jl invalid
    cmp State.move, 8
    jg invalid
    load tmp, Board.board, State.move, 8
    cmp tmp, State.P_EMPTY
    jne invalid
    store State.current_player, Board.board, State.move, 8
    add State.turn, State.turn, 1
    ret
  invalid:
    print invalid_move
    jmp read_again
  }
}

object AI {
  section data {
    string ai_msg = "Computer chooses position %d\\n"
    int zdx = 0
    int tmp = 0
  }

  section code {
  function turn:
    mov zdx, State.move
    add zdx, zdx, 1
    cmp zdx, 9
    jl try_slot
    mov zdx, 0
  try_slot:
    load tmp, Board.board, zdx, 8
    cmp tmp, State.P_EMPTY
    je choose
    add zdx, zdx, 1
    cmp zdx, 9
    jl try_slot
    mov zdx, 0
    jmp try_slot
  choose:
    store State.P_O, Board.board, zdx, 8
    print ai_msg, zdx
    add State.turn, State.turn, 1
    ret
  }
}
`;
      document.getElementById('codeInput').value = exampleCode;
    }

   document.getElementById('downloadZipBtn')
  .addEventListener('click', async () => {
    const out = document.getElementById('output');
    const areas = out.querySelectorAll('textarea[id^="asm-"]');
    if (areas.length === 0) {
      return showError("No assembly snippets found to zip.");
    }

    const titleElem = out.querySelector('.subtitle strong');
    const progName = titleElem?.textContent || 'program';
    const zip = new JSZip();

    let asmFiles = [];
    areas.forEach(ta => {
      const id = ta.id;
      let filename;
      if (id === 'asm-main') {
        filename = `${progName}.s`;
      } else {
        filename = `${id.slice(4)}.s`;
      }
      asmFiles.push(filename);
      zip.file(filename, ta.value);
    });

    
    const makefileContent = `all:\n\tgcc ${asmFiles.join(' ')} -o ${progName} -L/usr/local/lib/modules/io -lmxvm_io_static -L/usr/local/lib/modules/string -lmxvm_string_static\n`;
    zip.file('Makefile', makefileContent);

    const blob = await zip.generateAsync({ type: 'blob' });
    const url  = URL.createObjectURL(blob);
    const a    = document.createElement('a');
    a.href     = url;
    a.download = 'mxvm_assembly.zip';
    a.click();
    URL.revokeObjectURL(url);
  });
    
    document.getElementById('codeInput').addEventListener('keydown', function(e) {
      if (e.ctrlKey && e.key === 'Enter') {
        parseCode();
        return;
      }
      if (e.key === 'Tab') {
        e.preventDefault();
        const textarea = this;
        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        textarea.value = textarea.value.substring(0, start) + '\t' + textarea.value.substring(end);
        textarea.selectionStart = textarea.selectionEnd = start + 1;
      }
    });

    document.getElementById('parseBtn').disabled = true;
    document.getElementById('parseBtn').textContent = "‚è≥ Loading WebAssembly...";
  </script>
</body>
</html>